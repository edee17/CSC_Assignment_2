@{
    ViewData["Title"] = "Home Page";
}
@using System.Security.Claims
@using TheLifeTimeTalents.Services
@{var identity = Context.User.Identity as ClaimsIdentity;}
<div class="container" id="addarea">
    <div class="row col-md-10 col-md-offset-1">
        @*<button type="button" class="btn btn-success" data-toggle="modal" data-target="#addModal"><span class="glyphicon glyphicon-plus"></span> Add</button>*@
    </div>
</div>

<!-- adding new new talent -->
<div id="addModal" class="modal fade" role="dialog">
    <div class="modal-dialog">

        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Add</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">

                <form class="form-horizontal" enctype="multipart/form-data">
                    <!-- Text input-->
                    <div class="form-group">
                        <label class="col-md-4 control-label" for="addName">Name</label>
                        <div class="col-md-4">
                            <input style="width: 350%" maxlength="1000" id="addName" name="addName" type="text" placeholder="Barot Bellingham" class="form-control input-md" required="">

                        </div>
                    </div>

                    <!-- Text input-->
                    <div class="form-group">
                        <label class="col-md-4 control-label" for="addShortName">Short Name</label>
                        <div class="col-md-4">
                            <input style="width: 350%" maxlength="1000" id="addShortName" name="addShortName" type="text" placeholder="Barot_Bellingham" class="form-control input-md" required="">

                        </div>
                    </div>

                    <!-- Text input-->
                    <div class="form-group">
                        <label class="col-md-4 control-label" for="addReknown">Reknown</label>
                        <div class="col-md-4">
                            <input style="width: 350%" maxlength="1000" id="addReknown" name="addReknown" type="text" placeholder="Best F1 Driver" class="form-control input-md" required="">

                        </div>
                    </div>

                    <!-- Text input-->
                    <div class="form-group">
                        <label class="col-md-4 control-label" for="addImage">Link to Image</label>
                        <div class="col-md-4">
                            <input style="width: 350%" maxlength="1000" id="addImage" name="addImage" type="text" placeholder="http://placehold.it/160x160" class="form-control input-md" required="">
                            @*<input type="file" name="file" id="file" value="dataFile" required="">
                                <button onclick="uploadFile()">Upload to S3</button>*@
                        </div>
                    </div>

                    <!-- Textarea -->
                    <div class="form-group">
                        <label class="col-md-4 control-label" for="addBio">Bio</label>
                        <div class="col-md-4">
                            <textarea style="width: 350%" maxlength="10000" rows="12" placeholder="Description" class="form-control" id="addBio" name="addBio"></textarea>
                        </div>
                    </div>

                </form>


            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                <button id="btnAdd" name="btnAdd" type="button" class="btn btn-success">Add</button>
            </div>
        </div>

    </div>
</div>

<!-- editing talents-->
<div id="editModal" class="modal fade" role="dialog">
    <div class="modal-dialog">

        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Update</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">

                <form class="form-horizontal">

                    <!-- Text input-->
                    <div class="form-group">
                        <label class="col-md-4 control-label" for="editName">Name</label>
                        <div class="col-md-4">
                            <input style="width: 350%" maxlength="1000" id="editName" name="editName" type="text" placeholder="" class="form-control input-md" required="">

                        </div>
                    </div>

                    <!-- Text input-->
                    <div class="form-group">
                        <label class="col-md-4 control-label" for="editShortName">Short Name</label>
                        <div class="col-md-4">
                            <input style="width: 350%" maxlength="1000" id="editShortName" name="editShortName" type="text" placeholder="" class="form-control input-md" required="">

                        </div>
                    </div>

                    <!-- Text input-->
                    <div class="form-group">
                        <label class="col-md-4 control-label" for="editReknown">Reknown</label>
                        <div class="col-md-4">
                            <input style="width: 350%" maxlength="1000" id="editReknown" name="editReknown" type="text" placeholder="" class="form-control input-md" required="">

                        </div>
                    </div>

                    <!-- Text input-->
                    <div class="form-group">
                        <label class="col-md-4 control-label" for="editImage">Link to Image</label>
                        <div class="col-md-4">
                            <input style="width: 350%" maxlength="1000" id="editImage" name="editImage" type="text" placeholder="http://placehold.it/160x160" class="form-control input-md" required="">
                            @*<input type="file" name="file" id="file" value="dataFile" required="">
                                <button onclick="uploadFile()">Upload to S3</button>*@
                        </div>
                    </div>

                    <!-- Textarea -->
                    <div class="form-group">
                        <label class="col-md-4 control-label" for="editBio">Bio</label>
                        <div class="col-md-4">
                            <textarea style="width: 350%" maxlength="10000" rows="12" placeholder="Description" class="form-control" id="editBio" name="editBio"></textarea>
                        </div>
                    </div>

                </form>


            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                <button id="btnSave" name="btnSave" type="button" class="btn btn-success">Save</button>
            </div>
        </div>

    </div>
</div>

<!--deleting talents-->
<div id="deleteModal" class="modal fade" role="dialog">
    <div class="modal-dialog">

        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Delete</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body text-center">
                <h2>Are you sure you want to delete this?</h2>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button id="btnDelete" name="btnDelete" type="button" class="btn btn-danger">Delete</button>
            </div>
        </div>

    </div>
</div>

<!--disqus talents-->
<div id="disqusModal" class="modal fade" role="dialog">
    <div class="modal-dialog">

        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Comment</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body text-center">
                <div id="disqus_thread"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
        </div>

    </div>
</div>

@*<div class="container" id="results"></div>*@

<div id="searcharea">
    <label for="search">live search</label>
    <p>Enter the name or info about a speaker</p>
    <input type="search" name="search" id="search" placeholder="name or info" />
    <button type="button" class="btn btn-success" data-toggle="modal" data-target="#addModal"><span class="glyphicon glyphicon-plus"></span> Add</button>
    @*<input type="file" name="file" id="file" value="dataFile" required="">*@
    @*<button onclick="uploadFile()">Upload to S3</button>*@
    <div class="upload-photo">
        <input type="file" name="file" id="file" value="dataFile" onchange="uploadImage()">
        <div class="photo-container">
            <img class="photo" src="" alt="Image preview">
        </div>
    </div>
    <div class="analysis" id="analysis">
    </div>
</div>
<div id="update"></div>

@section Scripts{
    <style>

        body {
            background: #DAD7C7;
        }

        #searcharea {
            margin: 0 auto;
            text-align: center;
            background: #BF996B;
            padding: 10px;
            width: 30%;
            -webkit-border-radius: 10px 10px 0 0;
            -moz-border-radius: 10px 10px 0 0;
            border-radius: 10px 10px 0 0;
        }

            #searcharea label {
                font: bold 1.3em Arial;
                text-transform: uppercase;
                padding-bottom: 5px;
                color: #A61C1C;
            }

            #searcharea p {
                margin: 0;
                line-height: 1em;
                padding-bottom: 5px;
            }

            #searcharea input {
                width: 80%;
                text-align: center;
            }

        #update {
            font-family: Georgia, "Times New Roman", Times, serif;
            width: 70%;
            margin: 0 auto;
            border-top: 1px dotted #CCC;
        }

            #update ul {
                list-style: none;
                margin: 0;
                padding: 0;
            }

                #update ul li {
                    width: 100%;
                    padding: 0 20px;
                    background: #EEE;
                    padding-bottom: 10px;
                    height: 110px;
                    overflow: hidden;
                    border-bottom: 1px dotted #CCC;
                    -webkit-animation: myanim 1s;
                    -moz-animation: myanim 1s;
                    -o-animation: myanim 1s;
                    animation: myanim 1s;
                    -webkit-transition: height 0.3s ease-out;
                    -moz-transition: height 0.3s ease-out;
                    -o-transition: height 0.3s ease-out;
                    transition: height 0.3s ease-out;
                }

            #update li:hover {
                background: #FFFCE5;
                min-height: 110px;
                height: 250px;
                overflow: visible;
            }

            #update h2 {
                margin: 0;
                padding: 0;
                font-size: 1.2em;
                padding-bottom: 5px;
                padding-top: 20px;
                font-family: Arial, Helvetica, sans-serif;
                color: #BF5841;
                border-bottom: 1px dotted #CCC;
                margin-bottom: 10px;
            }

            #update img {
                float: left;
                width: 80px;
                margin-right: 10px;
                -webkit-border-radius: 10px;
                -moz-border-radius: 10px;
                border-radius: 10px;
            }

        @@-webkit-keyframes myanim {
            0% {
                opacity: 0.3;
            }

            100% {
                opacity: 1.0;
            }
        }

        @@-moz-keyframes myanim {
            0% {
                opacity: 0.3;
            }

            100% {
                opacity: 1.0;
            }
        }

        @@-o-keyframes myanim {
            0% {
                opacity: 0.3;
            }

            100% {
                opacity: 1.0;
            }
        }

        @@keyframes myanim {
            0% {
                opacity: 0.3;
            }

            100% {
                opacity: 1.0;
            }
        }

        #btnDelete {
            margin-left: 5px;
        }

        .photo {
            margin: auto;
            margin-top: 5px;
        }
    </style>

    <script type="text/javascript" src="https://sdk.clarifai.com/js/clarifai-latest.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
        var clarifaiApiKey = 'INSERT YOUR KEY HERE';
        var workflowId = 'INSERT YOUR WORKFLOW ID HERE';

        var app = new Clarifai.App({
            apiKey: clarifaiApiKey
        });

        // Handles image upload
        function uploadImage() {
            var preview = document.querySelector('img');
            var file = document.querySelector('input[type=file]').files[0];
            var reader = new FileReader();

            reader.addEventListener("load", function () {
                preview.src = reader.result;
                var imageData = reader.result;
                imageData = imageData.replace(/^data:image\/(.*);base64,/, '');
                predictFromWorkflow(imageData);
            }, false);

            if (file) {
                reader.readAsDataURL(file);
                preview.style.display = "inherit";
            }
        }

        // Analyzes image provided with Clarifai's Workflow API
        function predictFromWorkflow(photoUrl) {
            app.workflow.predict(workflowId, { base64: photoUrl }).then(
                function (response) {
                    var outputs = response.results[0].outputs;
                    var analysis = $(".analysis");

                    analysis.empty();
                    console.log(outputs);

                    outputs.forEach(function (output) {
                        var modelName = getModelName(output);

                        // Create heading for each section
                        var newModelSection = document.createElement("div");
                        newModelSection.className = modelName + " modal-container";

                        var newModelHeader = document.createElement("h2");
                        newModelHeader.innerHTML = modelName;
                        newModelHeader.className = "model-header";

                        var formattedString = getFormattedString(output);
                        var newModelText = document.createElement("p");
                        newModelText.innerHTML = formattedString;
                        newModelText.className = "model-text";

                        newModelSection.append(newModelHeader);
                        newModelSection.append(newModelText);
                        analysis.append(newModelSection);
                    });
                },
                function (err) {
                    console.log(err);
                }
            );
        }

        // Helper function to get model name
        function getModelName(output) {
            if (output.model.display_name !== undefined) {
                return output.model.display_name;
            } else if (output.model.name !== undefined) {
                return output.model.name;
            } else {
                return "";
            }
        }

        // Helper function to get output customized for each model
        function getFormattedString(output) {
            var formattedString = "";
            var data = output.data;
            console.log(data);
            var maxItems = 3;
            // NSFW
            if (output.model.model_version.id === "aa47919c9a8d4d94bfa283121281bcc4") {
                var items = data.concepts;

                formattedString = "This photo is:";
                var name;
                for (var i = 0; i < items.length; i++) {
                    var nsfw = (Math.round(items[1].value * 10000) / 100);
                    var sfw = (Math.round(items[0].value * 10000) / 100);
                    name = items[0].name;
                    formattedString += "<br/>- " + items[i].name + " at a " + (Math.round(items[i].value * 10000) / 100) + "% probability";

                }

                if (name == "sfw") {
                    //call upload method
                    formattedString += "<br/><br/><button onclick=\"uploadFile()\">Upload to S3</button>"
                }
            }
            return formattedString;
        }
    </script>

    <script>
        AWS.config.update({
            accessKeyId: 'INSERT YOUR KEY HERE',
            secretAccessKey: 'INSERT YOUR KEY HERE',
            sessionToken: 'INSERT YOUR KEY HERE'
        });
        AWS.config.region = 'us-east-1';

        function uploadFile() {
            var s3 = new AWS.S3({
                params: {
                    Bucket: 'csctalents2'
                    //Bucket: 'testingforcsc'
                }
            });
            var file = document.getElementById('file').files[0];
            if (file) {
                s3.putObject({
                    Key: file.name,
                    ContentType: file.type,
                    Body: file,
                    ACL: "public-read"
                },
                    function (err, data) {
                        if (data !== null) {
                            alert("Upload Successful!");
                        }
                        else {
                            alert("Upload Failed!");
                        }
                    });
            }
        }
    </script>

    <script>
        $('#search').keyup(function () {
            //get data from json file
            //var urlForJson = "data.json";

            //get data from Restful web Service in development environment
            var urlForJson = "/api/talents";

            //get data from Restful web Service in production environment
            //var urlForJson= "http://csc123.azurewebsites.net/api/talents";
            //var bio;
            //var name;
            //var output = '<ul class="searchresults">';
            //Url for the Cloud image hosting
            //var urlForCloudImage = "http://res.cloudinary.com/doh5kivfn/image/upload/v1460006156/talents/";
            //var urlForCloudImage = "https://sp-p1851830-s3-bucket-csc.s3.amazonaws.com/"
            //var urlForCloudImage = "https://csc-talentsearch.s3.amazonaws.com/"
            var urlForCloudImage = "https://csctalents2.s3.amazonaws.com/"
            //var urlForCloudImage = "https://testingforcsc.s3.amazonaws.com/"

            var searchField = $('#search').val();
            var myExp = new RegExp(searchField, "i");
            $.getJSON(urlForJson, function (data) {
                var output = '<ul class="searchresults">';
                $.each(data, function (key, val) {
                    //for debug
                    console.log(data);
                    if ((val.name.search(myExp) != -1) ||
                        (val.bio.search(myExp) != -1)) {
                        output += '<li>';
                        output += '<h2>' + val.name + '</h2>';
                        //output += '<img src="images/' + val.ShortName + '_tn.jpg" alt="' + val.Name + '" />';
                        //output += '<img src=' + urlForCloudImage + val.ShortName + "_tn.jpg alt=" + val.Name + '" />';
                        //output += '<p>' + val.Bio + '</p>';
                        @{ 
                            string roleName = "";
                            if (identity.IsAuthenticated)
                            {
                                roleName = identity.FindFirst("RoleName").ToString().Contains("Registered Paid Plan User").ToString();
                            }
                        }
                        if ("@roleName" == "True" ) {
                            //output += '<button class="btn btn-warning pull-right" data-toggle="modal" data-target="#editModal" data-talentid="' + val.id + '"><i class="fas fa-edit"></i></button>';
                            //output += '<button id="btnDelete" class="btn btn-danger pull-right" data-toggle="modal" data-target="#deleteModal" data-talentid="' + val.id + '"><i class="fas fa-trash"></i></button>';
                            output +=   `<button id="btnComment" class="btn btn-success pull-right" data-toggle="modal" data-target="#disqusModal" value=${val.id}><i class="fas fa-comments "></i></button>`
                        }

                        //get the image from cloud hosting
                        output += '<img src=' + urlForCloudImage + val.shortName + "_tn.jpg alt=" + val.name + '" />';
                        output += '<p>' + val.bio + '</p>';
                        output += '</li>';

                        /*Long URL must start with a protocol, bitly can't (and won't) figure out the right protocol.*/
                        ShortLinkBitly(urlForCloudImage + val.shortName + '_tn.jpg');
                    }
                });
                output += '</ul>';
                $('#update').html(output);
            }); //get JSON
        });

        //var shortURL = ShortLinkBitly("https://sp-p1851830-s3-bucket-csc.s3.amazonaws.com/Barot_Bellingham_tn.jpg");
        /*********************************************
        * Short Link using Bitly
        *********************************************/
        function ShortLinkBitly(pLongUrl) { /*pLongUrl is the long URL*/

            /*Long URL must start with a protocol, bitly can't (and won't) figure out the right protocol.*/
            if (!pLongUrl.match(/(ftp|http|https):\/\//i)) {
                return "Error: Link must start with a protocol (e.g.: http or https).";
            }

            var apiKey = 'INSERT YOUR KEY HERE';
            var username = 'edee17';
            //var test = {
            //    long_url: pLongUrl
            //    };



            /*Ajax call*/
            $.ajax({
                url: 'https://api-ssl.bitly.com/v3/shorten?login=' + username + '&access_token=' + apiKey + '&format=json&longUrl=' + encodeURIComponent(pLongUrl),
                //  url: 'https://api-ssl.bitly.com/v4/shorten=',
                //dataType: 'jsonp',
                type: 'POST',
                //headers: {
                //    "Authorization":
                //        "Bearer d9bb5dd43b6db46a07f4ab1a293421fbea784482",
                //},
                //data: JSON.stringify(test),

                success: function (response) {

                    console.log(response);
                    console.log(response.data.url);
                    if (response.status_code == 500) {

                        /*500 status code means the link is malformed.*/
                        return "Error: Invalid link.";

                    } else if (response.status_code != 200) {

                        /*If response is not 200 then an error ocurred. It can be a network issue or bitly is down.*/
                        return "Error: Service unavailable.";

                        /*Uncomment the following line only for debugging purposes*/
                        /*console.log('Response: ' + response.status_code + '-' + response.status_txt);*/
                    }
                    else
                        return response.data.url; /* OK, return the short link */
                },
                error: function (response) {
                    console.log(response);
                },

                contentType: 'application/json'
            });

        }
        /* END: Short Link using Bitly */


        var talentId;

        $('#addModal').on('shown.bs.modal', function (e) {
            if (sessionStorage.getItem('tokenKey') == null || sessionStorage.getItem('username') == null) {
                alertDone('Login to access this feature');
            }
            else {
            }
        });

        //to add
        $('#btnAdd').click(function () {

            alert("Data is being added to Database");

            if ($("#addName").val().trim().length == 0 || $("#addShortName").val().trim().length == 0 || $("#addReknown").val().trim().length == 0 || $("#addImage").val().trim().length == 0 || $("#addBio").val().trim().length == 0) {
                alert('Please Fill In The Information!');
            }

            else {
                var talent = {
                    Name: $('#addName').val(),
                    ShortName: $('#addShortName').val(),
                    Reknown: $('#addReknown').val(),
                    Bio: $('#addBio').val(),
                    ImageLink: $('#addImage').val(),
                    CreatedBy: sessionStorage.getItem('username'),
                    UpdatedBy: sessionStorage.getItem('username')
                };

                $.ajax({
                    url: '/api/talents',
                    headers: { 'Authorization': 'Bearer ' + sessionStorage.getItem('tokenKey') },
                    cache: false,
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(talent),
                    statusCode: {
                        201: function () {
                            hideModal();
                        }
                    }
                }).success(function (data) {
                    hideModal();
                    window.location.reload();
                });
            }
        });

        //to get Id for updating
        $('#editModal').on('shown.bs.modal', function (e) {
            if (sessionStorage.getItem('tokenKey') == null || sessionStorage.getItem('username') == null) {
                alertDone('Login to access this feature');
            }
            else {
                talentId = $(e.relatedTarget).data('talentid');
                getTalent(talentId);
            }
        });

        //to update
        $('#btnSave').click(function () {
            alert("updating...");

            if ($("#editName").val().trim().length == 0 || $("#editShortName").val().trim().length == 0 || $("#editReknown").val().trim().length == 0 || $("#editImage").val().trim().length == 0 || $("#editBio").val().trim().length == 0) {
                alert('Please Fill In The Information!');
            }

            else {

                var talent = {
                    Name: $('#editName').val(),
                    ShortName: $('#editShortName').val(),
                    Reknown: $('#editReknown').val(),
                    Bio: $('#editBio').val(),
                    ImageLink: $('#editImage').val(),
                    UpdatedBy: sessionStorage.getItem("username")
                };

                $.ajax({
                    url: '/api/talents/' + talentId,
                    headers: { 'Authorization': 'Bearer ' + sessionStorage.getItem('tokenKey') },
                    cache: false,
                    type: 'PUT',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(talent),
                    success: function () {
                        hideModal();
                    }
                }).done(function (response) {
                    alert(response);
                });
            }
        });

        //to get Id for deleting
        $('#deleteModal').on('shown.bs.modal', function (e) {
            if (sessionStorage.getItem('tokenKey') == null || sessionStorage.getItem('username') == null) {
                alertDone('Login to access this feature');
            }
            else {
                talentId = $(e.relatedTarget).data('talentid');
            }
        });

        //to delete
        $('#btnDelete').click(function () {

            $.ajax({
                url: '/api/talents/' + talentId,
                headers: { 'Authorization': 'Bearer ' + sessionStorage.getItem('tokenKey') },
                cache: false,
                type: 'Delete',
                contentType: 'application/json; charset=utf-8',
                success: function () {
                    hideModal();
                }
            }).done(function (data) {
                alert(data);
            });
        });

        //to get info about 1 and display in form
        function getTalent(talentId) {
            $.ajax({
                url: '/api/talents/' + talentId,
                cache: false,
                type: 'GET',
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    $('#editName').val(data.Name);
                    $('#editShortName').val(data.ShortName);
                    $('#editReknown').val(data.Reknown);
                    $('#editBio').val(data.Bio);
                    $('#editImage').val(data.ImageLink);
                }
            });
        }
        $('#btnComment').on('click', function () {
            loadDisqus(this.val());
        });
        function loadDisqus(id) {
            /**
        *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
        *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

            var disqus_config = function () {
                this.page.url = "http://localhost:64084";  // Replace PAGE_URL with your page's canonical URL variable
                this.page.identifier = id; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
            };

        (function () { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');
            s.src = 'https://lttalents.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
        }
        
    </script>
}
